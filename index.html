<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Şantiye Hatalı İmalat (Offline)</title>
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{color-scheme:dark}
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#111;color:#eee}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:8px 0 16px}
    label{display:block;margin:12px 0 6px;color:#bbb;font-size:13px}
    select,input,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#eee;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #222;background:#151515;border-radius:14px;padding:14px;margin:12px 0}
    .muted{color:#9aa0a6;font-size:13px}
    .ok{color:#7CFC98}
    .warn{color:#ffd37a}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer}
    button.primary{background:#2b7cff;border-color:#2b7cff}
    button.good{background:#1f8b4c;border-color:#1f8b4c}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    img{max-width:100%;border-radius:12px;border:1px solid #222;margin-top:10px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #333;border-radius:999px;font-size:12px;margin-left:8px}
    .small{font-size:12px}
    .hint{color:#8a8f98;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Hatalı İmalat Takip <span class="pill">Offline</span></h1>

  <div class="card">
    <div class="muted" id="net">Bağlantı: kontrol ediliyor…</div>

    <label>Ada</label>
    <select id="ada"></select>

    <label>Tip / Blok Grubu</label>
    <select id="tip" disabled></select>

    <label>Blok</label>
    <select id="blok" disabled></select>
    <input id="blok_text" style="display:none" placeholder="Blok yaz (Diğer seçildi)" />

    <div class="row">
      <div>
        <label>Kat</label>
        <select id="kat"></select>
      </div>
      <div>
        <label>İmalat</label>
        <select id="imalat"></select>
      </div>
    </div>

    <label>Hata Açıklaması</label>
    <textarea id="aciklama" placeholder="Kısa ve net açıklama..."></textarea>

    <label>Fotoğraf (zorunlu) — otomatik küçültülür</label>
    <input id="foto" type="file" accept="image/*" capture="environment" />
    <img id="preview" style="display:none" alt="Önizleme">
    <div class="muted small" id="psize" style="margin-top:6px"></div>

    <div class="btns">
      <button class="good" id="save">Kaydet (Offline)</button>
      <button class="primary" id="sync">Gönder / Senkronize</button>
      <button class="ghost" id="clear">Temizle</button>
    </div>

    <div class="muted" style="margin-top:10px">
      Kuyruk: <span id="qcount">0</span> kayıt
      <span id="last" style="margin-left:10px"></span>
    </div>

    <div class="muted small" style="margin-top:8px">
      <b>SÜRÜM: v6</b> (Dinamik ADA→TİP→BLOK + IndexedDB offline + no-cors sync)
    </div>
  </div>

  <div class="card">
    <b>Kayıtlar (Cihazda)</b>
    <div class="muted">İnternet yokken birikir. İnternet gelince “Gönder” ile aktarılır.</div>
    <div id="list" style="margin-top:10px"></div>
  </div>
</div>

<script>
  // =======================
  // 0) AYARLAR
  // =======================
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbycdbgff4_pGzZ6bYb2VUqTQnaW_mY9k5IcHy_QPFzHi9S0lfUpB63aCiPQzDibbpt6/exec";
  const API_KEY = "12345";

  // =======================
  // 1) VERİ: ADA → TİP → BLOKLAR
  // =======================
  // Buradaki örnekleri kendi Excel’inden kopyalayıp aynen yerleştir.
  // Yapı şu:
  // "1.ADA": {
  //   "A BLOKLAR": ["A-01","A-02"],
  //   "A-B BLOK": ["A-01/B-01","A-04/B-02"],
  //   ...
  // }
  const BLOK_DATA = {
    "1.ADA": {
      "A BLOKLAR": ["A-02","A-03"],
      "A-B BLOK": ["A-01/B-01","A-04/B-02","A-05/B-03"],
      "C BLOK": ["C-01","C-02","C-03","C-04","C-05","C-06","C-07"],
      "D BLOK": ["D-01","D-02","D-03","D-04","D-05","D-06"],
      "C-D BLOK": []
    },
    "2.ADA": {
      "A BLOKLAR": ["A-06","A-07","A-09","A-10","A-11","A-13"],
      "A-B BLOK": ["A-08/B-04","A-12/B-05"],
      "C BLOK": ["C-10"],
      "D BLOK": ["D-07","D-08","D-11","D-12","D-13","D-14"],
      "C-D BLOK": ["C-08/D-09","C-09/D-10"]
    },
    "3.ADA": {
      "A BLOKLAR": ["A-14","A-16","A-17"],
      "A-B BLOK": ["A-15/B-06"],
      "C BLOK": ["C-11","C-12","C-13"],
      "D BLOK": ["D-15","D-16","D-17"],
      "C-D BLOK": []
    },
    "4.ADA": {
      "A BLOKLAR": ["A-18"],
      "A-B BLOK": [],
      "C BLOK": ["C-14","C-15","C-16"],
      "D BLOK": ["D-18","D-19"],
      "C-D BLOK": []
    },
    "5.ADA": {
      "A BLOKLAR": ["A-19","A-20"],
      "A-B BLOK": [],
      "C BLOK": ["C-18","C-19"],
      "D BLOK": [],
      "C-D BLOK": ["C-17/D-20","C-20/D-21"]
    },
    "6.ADA": {
      "A BLOKLAR": [],
      "A-B BLOK": ["A-21/B-07"],
      "C BLOK": ["C-23"],
      "D BLOK": ["D-22"],
      "C-D BLOK": ["C-21/D-24"]
    }
  };

  // =======================
  // 2) SABİT LİSTELER
  // =======================
  const KATLAR = ["1.KAT","2.KAT","3.KAT","4.KAT","5.KAT","6.KAT"];
  const IMALATLAR = ["DUVAR","SIVA","BOYA","ŞAP","SERAMİK","PARKE DÖŞEME","ASMA TAVAN","PVC DOĞRAMA","CAM","MOBİLYE","VİTRİFİYE"];

  // =======================
  // 3) UI yardımcıları
  // =======================
  const $ = (id) => document.getElementById(id);
  const netEl = $("net"), qEl = $("qcount"), lastEl = $("last"), listEl = $("list");
  const preview = $("preview"), psize = $("psize");

  function setNet() {
    const ok = navigator.onLine;
    netEl.textContent = "Bağlantı: " + (ok ? "ONLINE" : "OFFLINE");
    netEl.className = ok ? "muted ok" : "muted warn";
  }
  window.addEventListener("online", setNet);
  window.addEventListener("offline", setNet);
  setNet();

  function setOptions(selectEl, items, placeholder="Seçiniz") {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = it;
      opt.textContent = it;
      selectEl.appendChild(opt);
    }
  }

  // =======================
  // 4) DİNAMİK AÇILIR LİSTELER
  // =======================
  const adaEl = $("ada");
  const tipEl = $("tip");
  const blokEl = $("blok");
  const blokTextEl = $("blok_text");

  function initDropdowns() {
    const adalar = Object.keys(BLOK_DATA);
    setOptions(adaEl, adalar, "Ada seçiniz");
    setOptions($("kat"), KATLAR, "Kat seçiniz");
    setOptions($("imalat"), IMALATLAR, "İmalat seçiniz");

    tipEl.disabled = true;
    blokEl.disabled = true;

    adaEl.addEventListener("change", () => {
      blokTextEl.style.display = "none";
      blokTextEl.value = "";
      blokEl.value = "";
      tipEl.value = "";

      const ada = adaEl.value;
      if (!ada) {
        tipEl.disabled = true;
        blokEl.disabled = true;
        setOptions(tipEl, [], "Önce ada seçiniz");
        setOptions(blokEl, [], "Önce tip seçiniz");
        return;
      }

      const tips = Object.keys(BLOK_DATA[ada] || {});
      setOptions(tipEl, tips, "Tip seçiniz");
      tipEl.disabled = false;

      setOptions(blokEl, [], "Önce tip seçiniz");
      blokEl.disabled = true;
    });

    tipEl.addEventListener("change", () => {
      blokTextEl.style.display = "none";
      blokTextEl.value = "";

      const ada = adaEl.value;
      const tip = tipEl.value;
      if (!ada || !tip) {
        setOptions(blokEl, [], "Önce tip seçiniz");
        blokEl.disabled = true;
        return;
      }

      const blocks = (BLOK_DATA[ada] && BLOK_DATA[ada][tip]) ? BLOK_DATA[ada][tip] : [];
      const list = [...blocks];
      list.sort((a,b)=>a.localeCompare(b, "tr"));

      // “Diğer” opsiyonu (listede yoksa yazabilsin)
      list.push("Diğer (Yaz)");

      setOptions(blokEl, list, "Blok seçiniz");
      blokEl.disabled = false;
    });

    blokEl.addEventListener("change", () => {
      if (blokEl.value === "Diğer (Yaz)") {
        blokTextEl.style.display = "block";
        blokTextEl.focus();
      } else {
        blokTextEl.style.display = "none";
        blokTextEl.value = "";
      }
    });

    // ilk durum
    setOptions(tipEl, [], "Önce ada seçiniz");
    setOptions(blokEl, [], "Önce tip seçiniz");
  }

  // =======================
  // 5) OFFLINE KUYRUK (IndexedDB)
  // =======================
  const DB_NAME = "santiye_db_v6";
  const STORE = "kuyruk";

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const os = db.createObjectStore(STORE, { keyPath: "id" });
          os.createIndex("sent", "sent", { unique:false });
          os.createIndex("createdAt", "createdAt", { unique:false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function dbPut(item) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(item);
      tx.oncomplete = () => res(true);
      tx.onerror = () => rej(tx.error);
    });
  }

  async function dbGetAll() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = () => rej(req.error);
    });
  }

  async function dbMarkSent(id) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readwrite");
      const os = tx.objectStore(STORE);
      const r = os.get(id);
      r.onsuccess = () => {
        const item = r.result;
        if (!item) return res(false);
        item.sent = true;
        os.put(item);
      };
      tx.oncomplete = () => res(true);
      tx.onerror = () => rej(tx.error);
    });
  }

  // =======================
  // 6) FOTO SIKIŞTIRMA
  // =======================
  async function compressImage(file, maxSize=1600, quality=0.75) {
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = URL.createObjectURL(file);
    });

    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSize / Math.max(w, h));
    const nw = Math.round(w * scale);
    const nh = Math.round(h * scale);

    const canvas = document.createElement("canvas");
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);

    const dataUrl = canvas.toDataURL("image/jpeg", quality);
    URL.revokeObjectURL(img.src);
    return dataUrl;
  }

  let PHOTO_DATA_URL = "";

  $("foto").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    PHOTO_DATA_URL = await compressImage(f, 1600, 0.75);
    preview.src = PHOTO_DATA_URL;
    preview.style.display = "block";
    const approxBytes = Math.round((PHOTO_DATA_URL.length * 3) / 4);
    psize.textContent = `Sıkıştırılmış foto yaklaşık: ${Math.round(approxBytes/1024)} KB`;
  });

  function clearForm() {
    adaEl.value = "";
    tipEl.value = "";
    blokEl.value = "";
    $("kat").value = "";
    $("imalat").value = "";
    $("aciklama").value = "";
    $("foto").value = "";
    preview.style.display = "none";
    preview.src = "";
    psize.textContent = "";
    PHOTO_DATA_URL = "";

    tipEl.disabled = true;
    blokEl.disabled = true;
    blokTextEl.style.display = "none";
    blokTextEl.value = "";

    setOptions(tipEl, [], "Önce ada seçiniz");
    setOptions(blokEl, [], "Önce tip seçiniz");
  }

  function getSelectedBlok() {
    if (blokEl.value === "Diğer (Yaz)") {
      return (blokTextEl.value || "").trim();
    }
    return (blokEl.value || "").trim();
  }

  function validate() {
    const ada = (adaEl.value || "").trim();
    const tip = (tipEl.value || "").trim();
    const blok = getSelectedBlok();
    const kat = ($("kat").value || "").trim();
    const imalat = ($("imalat").value || "").trim();
    const aciklama = ($("aciklama").value || "").trim();

    if (!ada || !tip || !blok || !kat || !imalat) return { ok:false, msg:"Ada/Tip/Blok/Kat/İmalat zorunlu." };
    if (!aciklama) return { ok:false, msg:"Hata açıklaması zorunlu." };
    if (!PHOTO_DATA_URL) return { ok:false, msg:"Fotoğraf zorunlu." };
    return { ok:true };
  }

  // =======================
  // 7) KAYDET (OFFLINE)
  // =======================
  $("save").addEventListener("click", async () => {
    const v = validate();
    if (!v.ok) return alert(v.msg);

    const item = {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random(),
      createdAt: new Date().toISOString(),
      ada: adaEl.value.trim(),
      tip: tipEl.value.trim(),
      blok: getSelectedBlok(),
      kat: $("kat").value.trim(),
      imalat: $("imalat").value.trim(),
      aciklama: $("aciklama").value.trim(),
      photoDataUrl: PHOTO_DATA_URL,
      apiKey: API_KEY,
      sent: false
    };

    await dbPut(item);
    lastEl.textContent = "• Kaydedildi (offline)";
    clearForm();
    await refreshList();
  });

  // =======================
  // 8) SENKRON (ONLINE) – no-cors POST
  // =======================
  async function postNoCors(item) {
    const body = new URLSearchParams({ payload: JSON.stringify(item) });
    await fetch(ENDPOINT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });
  }

  $("sync").addEventListener("click", async () => {
    if (!navigator.onLine) return alert("İnternet yok. Online olunca tekrar deneyin.");

    $("sync").disabled = true;
    try {
      const all = await dbGetAll();
      const pending = all.filter(x => !x.sent);
      if (pending.length === 0) {
        alert("Gönderilecek kayıt yok.");
        return;
      }

      let sentCount = 0;
      for (const item of pending) {
        await postNoCors(item);
        await dbMarkSent(item.id);
        sentCount++;
        await refreshList();
      }

      lastEl.textContent = `• ${sentCount} kayıt gönderildi ✔️ (Sheet/Drive’dan kontrol et)`;
      alert("Gönderildi ✅ Google Sheet (KAYITLAR) ve Drive klasöründen kontrol et.");
    } catch (e) {
      alert("Gönderim durdu: " + (e?.message || e));
    } finally {
      $("sync").disabled = false;
    }
  });

  $("clear").addEventListener("click", clearForm);

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refreshList() {
    const q = await dbGetAll();
    q.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||""));

    qEl.textContent = q.length;

    listEl.innerHTML = "";
    if (!q.length) {
      listEl.innerHTML = `<div class="muted">Henüz kayıt yok.</div>`;
      return;
    }

    for (const item of q) {
      const div = document.createElement("div");
      div.className = "card";
      div.style.margin = "10px 0";
      div.innerHTML = `
        <div><b>${item.ada}</b> • ${item.tip} • <b>${item.blok}</b> • ${item.kat} • ${item.imalat}</div>
        <div class="muted">${new Date(item.createdAt).toLocaleString("tr-TR")} • Durum: ${item.sent ? "Gönderildi" : "Bekliyor"}</div>
        <div style="margin-top:8px">${escapeHtml(item.aciklama)}</div>
      `;
      listEl.appendChild(div);
    }
  }

  // =======================
  // 9) BAŞLAT
  // =======================
  initDropdowns();
  refreshList();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
