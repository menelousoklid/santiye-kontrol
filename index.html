<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Şantiye Hatalı İmalat (Offline)</title>
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{color-scheme:dark}
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#111;color:#eee}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:8px 0 16px}
    label{display:block;margin:12px 0 6px;color:#bbb;font-size:13px}
    select,input,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#eee;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #222;background:#151515;border-radius:14px;padding:14px;margin:12px 0}
    .muted{color:#9aa0a6;font-size:13px}
    .ok{color:#7CFC98}
    .warn{color:#ffd37a}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer}
    button.primary{background:#2b7cff;border-color:#2b7cff}
    button.good{background:#1f8b4c;border-color:#1f8b4c}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    img{max-width:100%;border-radius:12px;border:1px solid #222;margin-top:10px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #333;border-radius:999px;font-size:12px;margin-left:8px}
    .small{font-size:12px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0f0f0f;border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;display:inline-block}
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:14px
    }
    .modal{
      width:min(520px, 100%); background:#151515;border:1px solid #2a2a2a;border-radius:14px;padding:14px
    }
    .modal h2{margin:6px 0 10px;font-size:16px}
    .modal .muted{line-height:1.35}
    iframe{display:none}
  </style>
</head>
<body>

<!-- PIN OVERLAY -->
<div class="overlay" id="pinOverlay" style="display:none">
  <div class="modal">
    <h2>Giriş (PIN)</h2>
    <div class="muted">Bu uygulama PIN ile korunur. Offline kullanabilmen için PIN kontrolü cihaz üzerinde yapılır.</div>
    <label>PIN</label>
    <input id="pinInput" inputmode="numeric" placeholder="****" />
    <div class="btns">
      <button class="primary" id="pinBtn">Giriş</button>
      <button class="ghost" id="pinHelp">Cihaz Kodu</button>
    </div>
    <div class="muted small" id="pinMsg" style="margin-top:8px"></div>
    <div class="muted small" style="margin-top:10px">
      <b>Not:</b> Yetkisiz cihazlar senkronizasyon yapsa bile kayıtlar Sheet’e yazdırılmaz.
    </div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <h1 style="margin:0">Hatalı İmalat Takip <span class="pill">Offline</span></h1>
  </div>

  <div class="card">
    <div class="muted" id="net">Bağlantı: kontrol ediliyor…</div>

    <div class="muted" style="margin-top:10px">
      <div><b>Cihaz Kodu (deviceId):</b> <span class="kbd" id="deviceIdText"></span></div>
      <div class="btns" style="margin-top:8px">
        <button class="ghost" id="copyDevice">Kopyala</button>
        <button class="ghost" id="showPin">PIN ekranı</button>
      </div>
      <div class="muted small">Bu kodu yetkilendirme için yöneticine gönder. (Sheet: YETKILI_CIHAZLAR)</div>
    </div>
  </div>

  <div class="card">
    <label>Ada</label>
    <select id="ada"></select>

    <label>Tip / Blok Grubu</label>
    <select id="tip" disabled></select>

    <label>Blok</label>
    <select id="blok" disabled></select>
    <input id="blok_text" style="display:none" placeholder="Blok yaz (Diğer seçildi)" />

    <div class="row">
      <div>
        <label>Kat</label>
        <select id="kat"></select>
      </div>
      <div>
        <label>İmalat</label>
        <select id="imalat"></select>
      </div>
    </div>

    <label>Hata Açıklaması</label>
    <textarea id="aciklama" placeholder="Kısa ve net açıklama..."></textarea>

    <label>Fotoğraf (zorunlu) — otomatik küçültülür</label>
    <input id="foto" type="file" accept="image/*" capture="environment" />
    <img id="preview" style="display:none" alt="Önizleme">
    <div class="muted small" id="psize" style="margin-top:6px"></div>

    <div class="btns">
      <button class="good" id="save">Kaydet (Offline)</button>
      <button class="primary" id="sync">Gönder / Senkronize</button>
      <button class="ghost" id="clearAll">Tümünü Sıfırla</button>
    </div>

    <div class="muted" style="margin-top:10px">
      Kuyruk: <span id="qcount">0</span> kayıt
      <span id="last" style="margin-left:10px"></span>
    </div>

    <div class="muted small" style="margin-top:8px">
      <b>SÜRÜM: v8</b> (PIN + device whitelist + doğrulanabilir sync)
    </div>
  </div>

  <div class="card">
    <b>Kayıtlar (Cihazda)</b>
    <div class="muted">İnternet yokken birikir. İnternet gelince “Gönder” ile aktarılır.</div>
    <div id="list" style="margin-top:10px"></div>
  </div>
</div>

<!-- hidden iframe for verified sync -->
<iframe name="sink" id="sink"></iframe>

<script>
  // =======================
  // 0) AYARLAR
  // =======================
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbycdbgff4_pGzZ6bYb2VUqTQnaW_mY9k5IcHy_QPFzHi9S0lfUpB63aCiPQzDibbpt6/exec";

  // Varsayılan PIN: 2580
  // Güvenlik: PIN'i HTML içinde düz metin tutmuyoruz; hash kontrolü yapıyoruz.
  // Bu hash Apps Script’teki PIN_HASH ile aynı olmalı.
  const PIN_HASH = "ed946f65d2c785d90e827c5ffd879ce3b49c68d4c88013074176a7e73bc58bcf";

  // =======================
  // 1) BLOK VERİSİ (dinamik)
  // =======================
  const BLOK_DATA = {
    "1.ADA": {"A BLOKLAR":["A-02","A-03"],"A-B BLOK":["A-01/B-01","A-04/B-02","A-05/B-03"],"C BLOK":["C-01","C-02","C-03","C-04","C-05","C-06","C-07"],"D BLOK":["D-01","D-02","D-03","D-04","D-05","D-06"],"C-D BLOK":[]},
    "2.ADA": {"A BLOKLAR":["A-06","A-07","A-09","A-10","A-11","A-13"],"A-B BLOK":["A-08/B-04","A-12/B-05"],"C BLOK":["C-10"],"D BLOK":["D-07","D-08","D-11","D-12","D-13","D-14"],"C-D BLOK":["C-08/D-09","C-09/D-10"]},
    "3.ADA": {"A BLOKLAR":["A-14","A-16","A-17"],"A-B BLOK":["A-15/B-06"],"C BLOK":["C-11","C-12","C-13"],"D BLOK":["D-15","D-16","D-17"],"C-D BLOK":[]},
    "4.ADA": {"A BLOKLAR":["A-18"],"A-B BLOK":[],"C BLOK":["C-14","C-15","C-16"],"D BLOK":["D-18","D-19"],"C-D BLOK":[]},
    "5.ADA": {"A BLOKLAR":["A-19","A-20"],"A-B BLOK":[],"C BLOK":["C-18","C-19"],"D BLOK":[],"C-D BLOK":["C-17/D-20","C-20/D-21"]},
    "6.ADA": {"A BLOKLAR":[],"A-B BLOK":["A-21/B-07"],"C BLOK":["C-23"],"D BLOK":["D-22"],"C-D BLOK":["C-21/D-24"]}
  };
  const KATLAR = ["1.KAT","2.KAT","3.KAT","4.KAT","5.KAT","6.KAT"];
  const IMALATLAR = ["DUVAR","SIVA","BOYA","ŞAP","SERAMİK","PARKE DÖŞEME","ASMA TAVAN","PVC DOĞRAMA","CAM","MOBİLYE","VİTRİFİYE"];

  // =======================
  // 2) UI
  // =======================
  const $ = (id) => document.getElementById(id);
  const netEl = $("net"), qEl = $("qcount"), lastEl = $("last"), listEl = $("list");
  const preview = $("preview"), psize = $("psize");
  const adaEl = $("ada"), tipEl = $("tip"), blokEl = $("blok"), blokTextEl = $("blok_text");

  function setNet() {
    const ok = navigator.onLine;
    netEl.textContent = "Bağlantı: " + (ok ? "ONLINE" : "OFFLINE");
    netEl.className = ok ? "muted ok" : "muted warn";
  }
  window.addEventListener("online", setNet);
  window.addEventListener("offline", setNet);
  setNet();

  function setOptions(selectEl, items, placeholder="Seçiniz") {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);
    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = it;
      opt.textContent = it;
      selectEl.appendChild(opt);
    }
  }

  // =======================
  // 3) Cihaz Kimliği
  // =======================
  const DEVICE_KEY = "santiye_device_id_v1";
  function getOrCreateDeviceId() {
    let id = localStorage.getItem(DEVICE_KEY);
    if (!id) {
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random());
      localStorage.setItem(DEVICE_KEY, id);
    }
    return id;
  }
  const DEVICE_ID = getOrCreateDeviceId();
  $("deviceIdText").textContent = DEVICE_ID;

  $("copyDevice").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(DEVICE_ID);
      alert("Kopyalandı ✅");
    } catch {
      alert("Kopyalanamadı. Elle seçip kopyala: " + DEVICE_ID);
    }
  });

  // =======================
  // 4) PIN Giriş (offline)
  // =======================
  const SESSION_PIN_OK = "santiye_pin_ok_v1";

  async function sha256Hex(str) {
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function showPinOverlay(msg="") {
    $("pinOverlay").style.display = "flex";
    $("pinMsg").textContent = msg;
    $("pinInput").value = "";
    $("pinInput").focus();
  }
  function hidePinOverlay() {
    $("pinOverlay").style.display = "none";
  }

  $("showPin").addEventListener("click", () => showPinOverlay(""));
  $("pinHelp").addEventListener("click", () => alert("Cihaz Kodu (deviceId):\n\n" + DEVICE_ID + "\n\nBu kodu Sheet > YETKILI_CIHAZLAR listesine eklemelisin."));

  $("pinBtn").addEventListener("click", async () => {
    const pin = $("pinInput").value.trim();
    if (!pin) return;
    const hex = await sha256Hex(pin);
    if (hex !== PIN_HASH) {
      return $("pinMsg").textContent = "PIN yanlış.";
    }
    sessionStorage.setItem(SESSION_PIN_OK, "1");
    sessionStorage.setItem("santiye_pin_hash_v1", hex);
    hidePinOverlay();
  });

  // ilk açılışta pin iste
  if (sessionStorage.getItem(SESSION_PIN_OK) !== "1") {
    showPinOverlay("");
  }

  function getPinHash() {
    return sessionStorage.getItem("santiye_pin_hash_v1") || "";
  }

  // =======================
  // 5) Seçim tercihleri (hızlı giriş)
  // =======================
  const PREF_KEY = "santiye_pref_v1";
  function savePrefs() {
    const prefs = {
      ada: adaEl.value,
      tip: tipEl.value,
      blok: blokEl.value,
      blok_text: blokTextEl.value,
      kat: $("kat").value,
      imalat: $("imalat").value
    };
    localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
  }
  function loadPrefs() {
    try { return JSON.parse(localStorage.getItem(PREF_KEY) || "{}"); } catch { return {}; }
  }

  // =======================
  // 6) Dinamik açılır listeler
  // =======================
  function initDropdowns() {
    setOptions(adaEl, Object.keys(BLOK_DATA), "Ada seçiniz");
    setOptions($("kat"), KATLAR, "Kat seçiniz");
    setOptions($("imalat"), IMALATLAR, "İmalat seçiniz");
    setOptions(tipEl, [], "Önce ada seçiniz");
    setOptions(blokEl, [], "Önce tip seçiniz");
    tipEl.disabled = true;
    blokEl.disabled = true;

    adaEl.addEventListener("change", () => {
      const ada = adaEl.value;
      if (!ada) {
        setOptions(tipEl, [], "Önce ada seçiniz");
        setOptions(blokEl, [], "Önce tip seçiniz");
        tipEl.disabled = true;
        blokEl.disabled = true;
        blokTextEl.style.display = "none";
        blokTextEl.value = "";
        savePrefs();
        return;
      }

      setOptions(tipEl, Object.keys(BLOK_DATA[ada] || {}), "Tip seçiniz");
      tipEl.disabled = false;

      setOptions(blokEl, [], "Önce tip seçiniz");
      blokEl.disabled = true;
      blokTextEl.style.display = "none";
      blokTextEl.value = "";
      savePrefs();
    });

    tipEl.addEventListener("change", () => {
      const ada = adaEl.value;
      const tip = tipEl.value;
      if (!ada || !tip) {
        setOptions(blokEl, [], "Önce tip seçiniz");
        blokEl.disabled = true;
        blokTextEl.style.display = "none";
        blokTextEl.value = "";
        savePrefs();
        return;
      }

      const blocks = (BLOK_DATA[ada] && BLOK_DATA[ada][tip]) ? BLOK_DATA[ada][tip] : [];
      const list = [...blocks].sort((a,b)=>a.localeCompare(b,"tr"));
      list.push("Diğer (Yaz)");
      setOptions(blokEl, list, "Blok seçiniz");
      blokEl.disabled = false;

      blokTextEl.style.display = "none";
      blokTextEl.value = "";
      savePrefs();
    });

    blokEl.addEventListener("change", () => {
      if (blokEl.value === "Diğer (Yaz)") {
        blokTextEl.style.display = "block";
        blokTextEl.focus();
      } else {
        blokTextEl.style.display = "none";
        blokTextEl.value = "";
      }
      savePrefs();
    });

    $("kat").addEventListener("change", savePrefs);
    $("imalat").addEventListener("change", savePrefs);
    blokTextEl.addEventListener("input", savePrefs);

    restorePrefs();
  }

  function restorePrefs() {
    const p = loadPrefs();
    if (!p.ada) return;

    adaEl.value = p.ada;
    adaEl.dispatchEvent(new Event("change"));

    if (p.tip) {
      tipEl.value = p.tip;
      tipEl.dispatchEvent(new Event("change"));
    }

    if (p.blok) {
      blokEl.value = p.blok;
      blokEl.dispatchEvent(new Event("change"));
    }
    if (p.blok === "Diğer (Yaz)") {
      blokTextEl.value = p.blok_text || "";
      blokTextEl.style.display = "block";
    }

    $("kat").value = p.kat || "";
    $("imalat").value = p.imalat || "";
  }

  // =======================
  // 7) Offline kuyruk (IndexedDB)
  // =======================
  const DB_NAME = "santiye_db_v8";
  const STORE = "kuyruk";

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const os = db.createObjectStore(STORE, { keyPath: "id" });
          os.createIndex("sent", "sent", { unique:false });
          os.createIndex("createdAt", "createdAt", { unique:false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function dbPut(item) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(item);
      tx.oncomplete = () => res(true);
      tx.onerror = () => rej(tx.error);
    });
  }

  async function dbGetAll() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = () => rej(req.error);
    });
  }

  async function dbMarkSent(id) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readwrite");
      const os = tx.objectStore(STORE);
      const r = os.get(id);
      r.onsuccess = () => {
        const item = r.result;
        if (!item) return res(false);
        item.sent = true;
        os.put(item);
      };
      tx.oncomplete = () => res(true);
      tx.onerror = () => rej(tx.error);
    });
  }

  // =======================
  // 8) Foto sıkıştırma
  // =======================
  async function compressImage(file, maxSize=1600, quality=0.75) {
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = URL.createObjectURL(file);
    });
    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSize / Math.max(w, h));
    const nw = Math.round(w * scale);
    const nh = Math.round(h * scale);
    const canvas = document.createElement("canvas");
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);
    const dataUrl = canvas.toDataURL("image/jpeg", quality);
    URL.revokeObjectURL(img.src);
    return dataUrl;
  }

  let PHOTO_DATA_URL = "";
  $("foto").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    PHOTO_DATA_URL = await compressImage(f, 1600, 0.75);
    preview.src = PHOTO_DATA_URL;
    preview.style.display = "block";
    const approxBytes = Math.round((PHOTO_DATA_URL.length * 3) / 4);
    psize.textContent = `Sıkıştırılmış foto yaklaşık: ${Math.round(approxBytes/1024)} KB`;
  });

  function getSelectedBlok() {
    if (blokEl.value === "Diğer (Yaz)") return (blokTextEl.value || "").trim();
    return (blokEl.value || "").trim();
  }

  function validate() {
    if (sessionStorage.getItem(SESSION_PIN_OK) !== "1") return { ok:false, msg:"Önce PIN gir." };

    const ada = (adaEl.value || "").trim();
    const tip = (tipEl.value || "").trim();
    const blok = getSelectedBlok();
    const kat = ($("kat").value || "").trim();
    const imalat = ($("imalat").value || "").trim();
    const aciklama = ($("aciklama").value || "").trim();

    if (!ada || !tip || !blok || !kat || !imalat) return { ok:false, msg:"Ada/Tip/Blok/Kat/İmalat zorunlu." };
    if (!aciklama) return { ok:false, msg:"Hata açıklaması zorunlu." };
    if (!PHOTO_DATA_URL) return { ok:false, msg:"Fotoğraf zorunlu." };
    return { ok:true };
  }

  // Kaydet/Gönder sonrası seçimler kalsın
  function clearAfterSaveOrSend() {
    $("aciklama").value = "";
    $("foto").value = "";
    preview.style.display = "none";
    preview.src = "";
    psize.textContent = "";
    PHOTO_DATA_URL = "";
  }

  // =======================
  // 9) Kaydet (offline)
  // =======================
  $("save").addEventListener("click", async () => {
    const v = validate();
    if (!v.ok) return alert(v.msg);

    const item = {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random(),
      createdAt: new Date().toISOString(),
      ada: adaEl.value.trim(),
      tip: tipEl.value.trim(),
      blok: getSelectedBlok(),
      kat: $("kat").value.trim(),
      imalat: $("imalat").value.trim(),
      aciklama: $("aciklama").value.trim(),
      photoDataUrl: PHOTO_DATA_URL,
      deviceId: DEVICE_ID,
      pinHash: getPinHash(),
      sent: false
    };

    await dbPut(item);
    savePrefs();
    lastEl.textContent = "• Kaydedildi (offline)";
    clearAfterSaveOrSend();
    await refreshList();
  });

  // =======================
  // 10) Doğrulanabilir Sync (form + iframe + postMessage)
  // =======================
  const pendingResolvers = new Map();

  window.addEventListener("message", async (event) => {
    const msg = event.data;
    if (!msg || msg.type !== "SANTIYE_SYNC") return;

    const data = msg.data || {};
    const id = data.id;
    if (!id) return;

    const resolve = pendingResolvers.get(id);
    if (resolve) {
      pendingResolvers.delete(id);
      resolve(data);
    }
  });

  function sendViaForm(item) {
    return new Promise((resolve, reject) => {
      // timeout
      const t = setTimeout(() => {
        pendingResolvers.delete(item.id);
        reject(new Error("Zaman aşımı (sunucu yanıt vermedi)."));
      }, 20000);

      pendingResolvers.set(item.id, (data) => {
        clearTimeout(t);
        resolve(data);
      });

      const form = document.createElement("form");
      form.method = "POST";
      form.action = ENDPOINT_URL;
      form.target = "sink";

      const inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = "payload";
      inp.value = JSON.stringify(item);

      form.appendChild(inp);
      document.body.appendChild(form);
      form.submit();
      form.remove();
    });
  }

  $("sync").addEventListener("click", async () => {
    if (!navigator.onLine) return alert("İnternet yok. Online olunca tekrar deneyin.");
    if (sessionStorage.getItem(SESSION_PIN_OK) !== "1") return showPinOverlay("Senkron için PIN gerekli.");

    $("sync").disabled = true;
    try {
      const all = await dbGetAll();
      const pending = all.filter(x => !x.sent);
      if (pending.length === 0) {
        alert("Gönderilecek kayıt yok.");
        return;
      }

      let okCount = 0;
      for (const item of pending) {
        // her seferinde güvenlik alanlarını tazele
        item.deviceId = DEVICE_ID;
        item.pinHash = getPinHash();

        const res = await sendViaForm(item);

        if (!res.ok) {
          alert("Gönderim reddedildi:\n\n" + (res.msg || "Bilinmeyen hata") + "\n\nCihaz Kodu:\n" + DEVICE_ID);
          // reddedildiyse KESİNLİKLE sent yapmıyoruz
          break;
        }

        await dbMarkSent(item.id);
        okCount++;
        await refreshList();
      }

      if (okCount > 0) {
        savePrefs();
        lastEl.textContent = `• ${okCount} kayıt gönderildi ✔️`;
        clearAfterSaveOrSend();
        alert("Gönderildi ✅ Google Sheet (KAYITLAR) ve Drive klasöründen kontrol et.");
      }
    } catch (e) {
      alert("Gönderim durdu: " + (e?.message || e));
    } finally {
      $("sync").disabled = false;
    }
  });

  // =======================
  // 11) Liste
  // =======================
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refreshList() {
    const q = await dbGetAll();
    q.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||""));
    qEl.textContent = q.length;

    listEl.innerHTML = "";
    if (!q.length) {
      listEl.innerHTML = `<div class="muted">Henüz kayıt yok.</div>`;
      return;
    }

    for (const item of q) {
      const div = document.createElement("div");
      div.className = "card";
      div.style.margin = "10px 0";
      div.innerHTML = `
        <div><b>${item.ada}</b> • ${item.tip} • <b>${item.blok}</b> • ${item.kat} • ${item.imalat}</div>
        <div class="muted">${new Date(item.createdAt).toLocaleString("tr-TR")} • Durum: ${item.sent ? "Gönderildi" : "Bekliyor"}</div>
        <div style="margin-top:8px">${escapeHtml(item.aciklama)}</div>
      `;
      listEl.appendChild(div);
    }
  }

  // =======================
  // 12) Reset
  // =======================
  $("clearAll").addEventListener("click", () => {
    if (!confirm("Tüm ayarlar (PIN oturumu/tercihler) sıfırlansın mı?")) return;
    localStorage.removeItem("santiye_pref_v1");
    sessionStorage.removeItem("santiye_pin_ok_v1");
    sessionStorage.removeItem("santiye_pin_hash_v1");
    location.reload();
  });

  // =======================
  // 13) Başlat
  // =======================
  initDropdowns();
  refreshList();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
